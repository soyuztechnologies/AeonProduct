var courseGUID;var customerGUID;var vEmail;var CourseFee;sap.ui.define(["oft/fiori/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","oft/fiori/models/formatter","sap/ui/model/Filter","sap/m/Token","sap/ui/model/FilterOperator","sap/ui/core/Fragment"],function(e,t,s,a,i,r,o,l){"use strict";return e.extend("oft.fiori.controller.newReg",{formatter:a,fnOnUpLoadFile:function(e){var t=this.getView().byId("imageUploader");var s=t.getFocusDomRef();var a=s.files[0];var i=this;if(a){var i=this;this.fileName=a.name;this.fileType=a.type;var r=new FileReader;r.onload=function(e){i.imgContent=e.currentTarget.result};r.readAsDataURL(a)}},handleTypeMissmatch:function(e){var t=e.getSource().getFileType();jQuery.each(t,function(e,s){t[e]="*."+s});var a=t.join(", ");s.show("The file type *."+e.getParameter("fileType")+" is not supported. Choose one of the following types: "+a)},handleSizeExceed:function(e){var t=e.getSource().getMaximumFileSize();s.show("Maximun file size allowed is "+t+" MB")},onScreenShot:function(e){var t=this;var s=e.getSource().getBindingContext().sPath;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),s,"GET",{},{},this).then(function(e){var t=e.PaymentScreenshot;var s=new sap.m.Dialog({title:"Payment Screen Shot"});s.addButton(new sap.m.Button({text:"OK",press:function(){s.close();s.destroyContent()}}));var a=new sap.m.Carousel({loop:true});var i=new sap.m.Image({src:t,alt:"",densityAware:true,decorative:false});a.addPage(i);s.addContent(a);s.open()}).catch(function(e){var s=t.getErrorMessage(e)})},onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.totalCount=0;var e=this.getModel("local").getProperty("/CurrentUser");if(e){var t=this.getModel("local").oData.AppUsers[e].UserName}t="Hey "+t;this.getView().byId("idUser").setText(t);this.UserRole=this.getOwnerComponent().getModel("local").getProperty("/Role");var s=this.getOwnerComponent().getModel();var a=new sap.ui.model.json.JSONModel;s.read("/Wards",{success:function(e,t){a.setData(e)},error:function(e){}});var i=this.getOwnerComponent().getModel();i.read("/Courses",{success:function(e,t){a.setData(e)},error:function(e){}});this.oRouter.attachRoutePatternMatched(this.herculis,this)},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},siteLink:"",eMailId:"",onGiveAccess:function(e){var t=this;var s=t.getView().byId("idSubsRecent").getSelectedContexts();for(var a=0;a<s["length"];a++){var i=s[a].getModel().getProperty(s[a].getPath());debugger;$.post("/giveAccess",i).done(function(e,t){sap.m.MessageToast.show("Access has been provided")}).fail(function(e,t,s){sap.m.MessageBox.error("Error in access")})}},onClearToken:function(){$.post("/clearToken").done(function(e,t){sap.m.MessageToast.show("Token is now reset")}).fail(function(e,t,s){sap.m.MessageBox.error("Error in access")})},onSendEmail:function(e){var t=this;var s=t.getView().byId("idSubsRecent").getSelectedContexts();for(var a=0;a<s["length"];a++){var i=s[a].getModel().getProperty(s[a].getPath());debugger;var t=this;var r={Status:"Access Granted"};if(this.passwords===""){this.passwords=prompt("Please enter your password","");if(this.passwords===""){sap.m.MessageBox.error("Blank Password not allowed");return}}i.password=t.passwords;i.includeX=t.getView().byId("includeX").getSelected();$.post("/sendSubscriptionEmail",i).done(function(e,t){sap.m.MessageToast.show("Email sent successfully")}).fail(function(e,s,a){t.passwords="";sap.m.MessageBox.error(e.responseText)})}},oSuppPopup:null,destoryDialog:function(){this.oSuppPopup.destroy();this.oSuppPopup=null},onItemPress:function(e){debugger;if(!this.oSuppPopup){this.oSuppPopup=new sap.ui.xmlfragment("oft.fiori.fragments.subSearch",this);sap.ui.getCore().getMessageManager().registerObject(this.oSuppPopup,true);this.getView().addDependent(this.oSuppPopup)}sap.ui.getCore().byId("updPay").setVisible(false);sap.ui.getCore().byId("idPortSubs").setVisible(false);sap.ui.getCore().byId("idExtendSubs").setVisible(false);var t=e.getSource().oBindingContexts.undefined.sPath;t=t.split("/")[1];var s=this.getView().getModel().oData[t];sap.ui.getCore().byId("idCourse_upd").setEnabled(false);sap.ui.getCore().byId("idPayDate_upd").setEnabled(false);sap.ui.getCore().byId("idEndDate_upd").setEnabled(false);sap.ui.getCore().byId("paymentMode_upd").setEnabled(false);sap.ui.getCore().byId("accountDetails_upd").setEnabled(false);sap.ui.getCore().byId("idAmount_upd").setEnabled(false);sap.ui.getCore().byId("idAmount_Txt").setText("Amount");sap.ui.getCore().byId("idReference_upd").setEnabled(false);sap.ui.getCore().byId("idRemarks_upd").setEnabled(false);sap.ui.getCore().byId("idPendingAmount_upd").setEnabled(false);sap.ui.getCore().byId("idPayDueDate_upd").setEnabled(false);this.customerEmail=e.getSource().mAggregations.cells[0].mProperties.text;this.courseName=e.getSource().mAggregations.cells[1].mProperties.text;this.prevPendingAmiount=s.PendingAmount;this.getView().getModel("local").setProperty("/newRegistration/StudentId",this.customerEmail);this.getView().getModel("local").setProperty("/newRegistration/CourseId",this.courseName);this.getView().getModel("local").setProperty("/newRegistration/PaymentMode",s.PaymentMode);this.getView().getModel("local").setProperty("/newRegistration/AccountName",s.AccountName);this.getView().getModel("local").setProperty("/BeneficiaryName",this.getAccountBeneficiary(s.AccountName));this.getView().getModel("local").setProperty("/newRegistration/Amount",s.Amount);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",s.PendingAmount);this.getView().getModel("local").setProperty("/newRegistration/Reference",s.Reference);this.getView().getModel("local").setProperty("/newRegistration/Remarks",s.Remarks);this.oSuppPopup.open()},onDelete:function(e){var s=this;t.confirm("Do you want to delete the selected records?",function(e){if(e=="OK"){var t=s.getView().byId("idSubsRecent").getSelectedContexts();for(var a=0;a<t["length"];a++){s.ODataHelper.callOData(s.getOwnerComponent().getModel(),t[a].sPath,"DELETE",{},{},s).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(e){s.getView().setBusy(false);s.oPopover=s.getErrorMessage(e);s.getView().setBusy(false)})}}},"Confirmation")},onRefresh:function(){var e=this.getView().byId("idPayDate");var t=e._lastValue.split(".");var s=new Date(t[2],t[1]-1,t[0]);s.setHours(0,0,0,0);var a=new sap.ui.model.Sorter("CreatedOn",true);var i=new sap.ui.model.Filter("PaymentDate","GE",s);var r=this.getView().byId("idSubsRecent");var o=r.getItems();r.getBinding("items").filter(i);r.getBinding("items").sort(a)},onSaveSubs:function(e){this.subsciptionSaved="false";var t=e;var s=this;var a=this.getView().getModel("local").getProperty("/newRegistration");var i=false;if(this.getView().byId("idPayDate").getDateValue()){i=this.formatter.getDateCheck(this.getView().byId("idPayDate").getDateValue());if(i==true){sap.m.MessageToast.show("Payment Date can't be in future");return""}}if(this.getView().byId("idRegDate").getDateValue()){i=false;i=this.formatter.getDateCheck(this.getView().byId("idRegDate").getDateValue());if(i==true){sap.m.MessageToast.show("Registration Date can't be in future");return""}}if(!this.getView().byId("idAmount").getValue()||this.getView().byId("idAmount").getValue()<=0){if(this.getView().byId("idAmount").getValue()==0){if(this.getView().byId("idWaiver").getSelected()==false){if(this.getView().byId("idPartPay").getSelected()==false){sap.m.MessageToast.show("Amount can't be 0, if waiver/partial payment not applied");return""}}}else if(this.getView().byId("idAmount").getValue()<0){sap.m.MessageToast.show("Amount can't be less than 0");return""}}if(this.getView().byId("idPendingAmount").getValue()<0){sap.m.MessageToast.show("Pending Amount can't be less than 0");return""}else if(this.getView().byId("idPendingAmount").getValue()>0){if(this.getView().byId("idPartPay").getSelected()==false){sap.m.MessageToast.show('Please check "Partial Payment" flag as Pending Amount is there');return""}}else if(this.getView().byId("idPendingAmount").getValue()==0){if(this.getView().byId("idPartPay").getSelected()==true){sap.m.MessageToast.show('Please uncheck "Partial Payment" flag as Pending Amount is 0');return""}}if(this.getView().byId("idPayDueDate").getDateValue()){var r=this.getView().byId("idPayDueDate").getValue().split(".");var o=this.getView().byId("idPayDate").getValue().split(".");o=o[2]+o[1]+o[0];r=r[2]+r[1]+r[0];if(o>r){sap.m.MessageToast.show("Payment Due Date can't be less than Payment Date");return""}}var l=null;if(this.UserRole=="Admin"){l="Approved"}else{l="Pending"}debugger;s.getView().setBusy(false);var n={StudentId:this.customerId,CourseId:this.courseId,PaymentDate:this.getView().byId("idPayDate").getDateValue(),Mode:a.Mode,StartDate:this.getView().byId("idRegDate").getDateValue(),EndDate:this.getView().byId("idRegEndDate").getDateValue(),PaymentMode:a.PaymentMode,BankName:a.BankName,AccountName:a.AccountName,Amount:a.Amount,Reference:a.Reference,Remarks:a.Remarks,PendingAmount:a.PendingAmount,Waiver:a.Waiver,PartialPayment:a.PartialPayment,PaymentDueDate:this.getView().byId("idPayDueDate").getDateValue(),PaymentScreenshot:this.imgContent,CreatedOn:new Date,CreatedBy:"DemoUser",ChangedOn:new Date,ChangedBy:"DemoUser",DropOut:false,Extra1:" ",Extra2:a.Extra2,ExtraN1:a.ExtraN1,ExtraN2:0,ExtraN3:0,UpdatePayment:false,MostRecent:true,Status:l};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Subs","POST",{},n,this).then(function(e){s.getView().setBusy(false);s.subsciptionSaved="true";sap.m.MessageToast.show("Subscription Saved successfully");s.destroyMessagePopover()}).catch(function(e){s.getView().setBusy(false);s.subsciptionSaved="false";var t=s.getErrorMessage(e)});this.getView().getModel().refresh()},onStartChange:function(e){var t=e.getSource().getValue();var s=t.split(".");var a=new Date(s[2],s[1]-1,s[0]);var i=this.formatter.getIncrementDate(a,8);this.getView().getModel("local").setProperty("/newRegistration/EndDate",i)},onPayDateChange:function(e){var t=e.getSource().getValue();var s=t.split(".");var a=new Date(s[2],s[1]-1,s[0]);var i=new Date(s[2],s[1]-1,s[0]);var r=this.formatter.getIncrementDate(a,1);this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",r);i.setHours(0,0,0,0);var o=new sap.ui.model.Sorter("CreatedOn",true);var l=new sap.ui.model.Filter("PaymentDate","GE",i);var n=this.getView().byId("idSubsRecent");var u=n.getItems();n.getBinding("items").filter(l);n.getBinding("items").sort(o)},herculis:function(e){if(e.getParameter("name")!=="newreg"){return}var t=new Date;t.setHours(0,0,0,0);var s=new sap.ui.model.Sorter("CreatedOn",true);var a=this.getView().byId("idSubsRecent");var i=a.getItems();var r=new sap.ui.model.Filter("PaymentDate","GE",t);a.getBinding("items").filter(r);a.getBinding("items").sort(s);this.getView().getModel("local").setProperty("/newRegistration/StartDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/EndDate",this.formatter.getFormattedDate(8));this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",this.formatter.getFormattedDate(1));this.getView().getModel("local").setProperty("/newRegistration/StudentId",null);this.getView().getModel("local").setProperty("/newRegistration/CourseId",null);this.getView().getModel("local").setProperty("/newRegistration/Mode","L");this.getView().getModel("local").setProperty("/newRegistration/PaymentMode","IMPS");this.getView().getModel("local").setProperty("/newRegistration/AccountName",null);this.getView().getModel("local").setProperty("/newRegistration/Amount",15e3);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false);this.getView().getModel("local").setProperty("/newRegistration/Reference",null);this.getView().getModel("local").setProperty("/newRegistration/Extra2",null);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false)},oSuppPopup:null,onCustomer:function(){if(!this.oSuppPopup){this.oSuppPopup=new sap.ui.xmlfragment("oft.fiori.fragments.newCustomer",this);sap.ui.getCore().getMessageManager().registerObject(this.oSuppPopup,true);this.getView().addDependent(this.oSuppPopup);this.oSuppPopup.setTitle("New Customer")}this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false);this.getView().getModel("local").setProperty("/newCustomer/HighServerUsage",false);sap.ui.getCore().byId("idSkills").clearSelection();this.oSuppPopup.open()},onUpdateFinished:function(e){debugger;var t=this.getView().byId("idSubsRecent");var s=t.getItems();var a=s.length;var i;var r;var o;var l=this.getView().getModel("local").getProperty("/Role");if(l==="Admin"){var n=0;for(var u=0;u<s.length;u++){debugger;n=n+parseInt(s[u].getCells()[5].getText())}t.getHeaderToolbar().getContent()[0].setText("Today : "+a+"  Amount:"+n)}else{t.getHeaderToolbar().getContent()[0].setText("Today : "+a)}debugger;for(var u=0;u<a;u++){var g=s[u].getCells()[1].getText();var d="Courses('"+g+"')";var p=this.getView().getModel().oData[d];if(p){var c=p.BatchNo;s[u].getCells()[1].setText(c)}debugger;var m=s[u].getCells()[0].getText();var h="Wards('"+m+"')";var y=this.getView().getModel().oData[h];if(y){var f=y.Name+"("+y.RollNo+")";s[u].getCells()[0].setText(f)}var C=s[u].getCells()[2].getItems()[0].getText();if(C=="Approved"){s[u].getCells()[2].getItems()[0].setText("Send Mail");s[u].getCells()[2].getItems()[0].setEnabled(true);s[u].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Unstyled)}else if(C=="Pending"){if(this.UserRole=="Admin"){s[u].getCells()[2].getItems()[0].setText("Approve");s[u].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Reject)}else{s[u].getCells()[2].getItems()[0].setEnabled(false);s[u].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Reject)}}else if(C=="Access Granted"||C=="Access granted"||C=="access Granted"||C=="access granted"){s[u].getCells()[2].getItems()[0].setEnabled(false);s[u].getCells()[2].getItems()[0].setType(sap.m.ButtonType.Accept)}o=s[u].getCells().length-2;r=s[u].getCells()[4].getText();if(this.getModel("local").getProperty("/AppUsers")[r]){i=this.getModel("local").getProperty("/AppUsers")[r].UserName}if(i){s[u].getCells()[4].setText(i)}}},passwords:"",onBank:function(e){this.oEvent_approve=e;var t=e.getSource().getBindingContext().sPath;var s=this;var a=s.oEvent_approve.getSource().getBindingContext().getModel().getProperty(s.oEvent_approve.getSource().getBindingContext().getPath());if(a.AccountName){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Accounts","GET",{filters:[new sap.ui.model.Filter("accountNo","EQ",a.AccountName)]},{},this).then(function(e){console.log(e.results[0].userId);try{navigator.clipboard.writeText(e.results[0].userId)}catch(e){}finally{}window.open(e.results[0].extra1)}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}},onApprove:async function(e){debugger;var t=this;var a=e.getSource().getParent().getBindingContext().getObject();var i=e.getSource();console.log(a);var r=a.Amount;var o=a.PaymentMode;var l=a.PaymentDate;var n=a.CreatedOn;var u=a.StudentId;var g=a.CourseId;var d;var p;var c;var m;var h="/Wards('"+u+"')/ToInquiry";await this.ODataHelper.callOData(this.getOwnerComponent().getModel(),h,"GET",null,null,this).then(function(e){debugger;c=e.FatherName;m=e.EmailId}).catch(function(e){debugger});var y="Wards('"+u+"')";var f=this.getView().getModel().oData[y];if(f){d=f.Name}var C="Courses('"+g+"')";var w=this.getView().getModel().oData[C];if(w){p=w.BatchNo}var P=new Date(n);var b=P.toLocaleString();var l=new Date(l);var v=l.toLocaleString();$.ajax({url:"sendPaymentVerificationEmail",type:"POST",data:{Parent_Name:c,Camper_Name:d,Camp_Program_Name:p,Program_Dates:b,Payment_Amount:r,Payment_Date:v,Payment_Method:o,Email:m},success:function(e){if(e=="Email sent successfully"){s.show("Email sent Successfully");if(i.getText()=="Send Mail"){i.setText("Access granted")}}},error:function(e){console.log(e)}})},searchPopup:null,onSelect:function(e){debugger;this.sId=e.getSource().getId();var t="",s="";if(this.sId.indexOf("customerId")!==-1){this.getCustomerPopup();var a=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(a);this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})})}else if(this.sId.indexOf("idEmailCust")!==-1){this.getCustomerPopup();var a=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(a);this.searchPopup.bindAggregation("items",{path:"/Inquries",template:new sap.m.DisplayListItem({label:"{EmailId}",value:"{FirstName}"})})}else if(this.sId.indexOf("courseId")!==-1){var i=new sap.ui.model.Filter("hidden",o.EQ,false);this.getCustomerPopup();var a=this.getView().getModel("i18n").getProperty("batch");this.searchPopup.setTitle(a);this.searchPopup.bindAggregation("items",{path:"/Courses",filters:[i],sorter:{path:"EndDate",descending:false,group:false},template:new sap.m.ObjectListItem({title:"{Name}",intro:"{BatchNo}",number:{path:"status",formatter:this.formatter.formatStatusValue}})});var r=this.searchPopup.getBinding("items");var l=[];var n="EndDate";var u=true;l.push(new sap.ui.model.Sorter(n,u));r.sort(l)}else if(this.sId.indexOf("accountDetails")!==-1){var g=new sap.ui.model.Filter("deleted",o.EQ,false);t="Account Search";s="local>/accountSet";this.getCustomerPopup();var a="Account Search";var d=new sap.ui.model.Sorter({path:"value",descending:false});this.searchPopup.setTitle(a);this.searchPopup.bindAggregation("items",{path:"local>/accountSet",filters:[g],sorter:d,template:new sap.m.DisplayListItem({label:"{local>value}",value:"{local>key}"})})}},onConfirm:function(e){debugger;if(this.sId.indexOf("accountDetails")!==-1){var t=e.getParameter("selectedItem").getValue();this.getView().getModel("local").setProperty("/newRegistration/AccountName",t)}else if(this.sId.indexOf("customerId")!==-1){var s=this.getObjListSelectedkey(e);this.getView().byId("customerId").setValue(s[0]);this.customerId=s[3]}else if(this.sId.indexOf("courseId")!==-1){var s=this.getObjListSelectedkey(e);this.getView().byId("idCourseName").setText(s[0]);this.getView().byId("courseId").setValue(s[1]);this.courseId=s[3];var a=e.getParameter("selectedItem");var i=a.getBindingContext();if(i.getObject().Fee){this.getView().byId("idAmount").setValue(i.getObject().Fee);CourseFee=i.getObject().Fee}else{CourseFee=0}var r=new Date(i.getObject().DemoStartDate);r.setMonth(r.getMonth()+1);if(r>new Date){this.getView().byId("idPayDueDate").setDateValue(r)}}else if(this.sId.indexOf("idEmailCust")!==-1){var a=e.getParameter("selectedItem");var i=a.getBindingContext();sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(i){var o=this;var l={};var n=new sap.ui.model.Filter("GmailId","EQ",i.getObject().EmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[n]},l,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");o.UpdateCustomer=true;o.customerGUID=e.results[0].id}else{var t;var s;sap.ui.getCore().byId("idEmailCust").setValue(i.getObject().EmailId);if(i.getObject().FirstName){if(i.getObject().LastName){t=i.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(i.getObject().FirstName+" "+t)}else{s="";if(i.getObject().LastName){t=i.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(s+" "+t)}if(i.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(i.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(i.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(i.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");o.UpdateCustomer=false}}).catch(function(e){var t;var s;sap.ui.getCore().byId("idEmailCust").setValue(i.getObject().EmailId);if(i.getObject().FirstName){if(i.getObject().LastName){t=i.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(i.getObject().FirstName+" "+t)}else{s="";if(i.getObject().LastName){t=i.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(s+" "+t)}if(i.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(i.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(i.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(i.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");o.UpdateCustomer=false})}}},suggestionItemSelected:function(e){var t=e.getParameter("selectedItem");var s=t.getBindingContext();sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(s){var a=this;var i={};var r=new sap.ui.model.Filter("GmailId","EQ",s.getObject().EmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[r]},i,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");a.UpdateCustomer=true;a.customerGUID=e.results[0].id}else{var t;var i;sap.ui.getCore().byId("idEmailCust").setValue(s.getObject().EmailId);if(s.getObject().FirstName){if(s.getObject().LastName){t=s.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(s.getObject().FirstName+" "+t)}else{i="";if(s.getObject().LastName){t=s.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(i+" "+t)}if(s.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(s.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(s.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(s.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");a.UpdateCustomer=false}}).catch(function(e){var t;var i;sap.ui.getCore().byId("idEmailCust").setValue(s.getObject().EmailId);if(s.getObject().FirstName){if(s.getObject().LastName){t=s.getObject().LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(s.getObject().FirstName+" "+t)}else{i="";if(s.getObject().LastName){t=s.getObject().LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(i+" "+t)}if(s.getObject().Phone){sap.ui.getCore().byId("idPhone").setValue(s.getObject().Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(s.getObject().Country){sap.ui.getCore().byId("idCountry").setSelectedKey(s.getObject().Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");a.UpdateCustomer=false})}},onAmountChange:function(e){var t=parseInt(e.getParameter("value"));if(t<CourseFee){var s=CourseFee-t;this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",s);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",true)}else{this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}},onWaiver:function(e){var t=e.getParameter("selected");if(t===true){this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}else{var s=this.getView().getModel("local").getProperty("/newRegistration/Amount");if(s<CourseFee){var a=CourseFee-s;this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",a);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",true)}else{this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false)}}},onSearch:function(e){debugger;if(this.sId.indexOf("customerId")!==-1){var t=this.getQuery(e);if(t){var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("GmailId",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("courseId")!==-1){var t=this.getQuery(e);if(t){var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("BatchNo",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Courses",template:new sap.m.DisplayListItem({label:"{Name}",value:"{BatchNo}"})});this.searchPopup.getBinding("items").filter([])}}},onCancel:function(e){this.searchPopup.close()},onClose:function(){this.oSuppPopup.close()},onCreateCust:function(e){var t=e;var s=this;s.getView().setBusy(true);var a=this.getView().getModel("local").getProperty("/newCustomer");var i=sap.ui.getCore().byId("idFileUploader");var r=i.getFocusDomRef();var o=r.files[0];if(o){var s=this;var l=o.name.split(".");var n=l.length;var u=o.type.split("/")[1];var g=l[n-1];if(g=="PDF"||g=="DOCX"||g=="DOC"||g=="pdf"||g=="docx"||g=="doc"||g=="msword"||g=="MSWORD"){var d=new FileReader;d.onload=function(e){if(g=="PDF"||g=="pdf"){s.FileContent=e.currentTarget.result.replace("data:application/pdf;base64,","")}else{if(u=="msword"){s.FileContent=e.currentTarget.result.replace("data:application/msword;base64,","")}else{s.FileContent=e.currentTarget.result.replace("data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,","")}}};d.readAsDataURL(o)}else{sap.m.MessageToast.show("File Type should be PDF or DOC");return""}}if(s.UpdateCustomer==false){var p={GmailId:a.GmailId,Name:a.Name,CompanyMail:a.CompanyMail,Country:a.Country,Designation:a.Designation,OtherEmail1:a.OtherEmail1,OtherEmail2:a.OtherEmail2,ContactNo:a.ContactNo,Star:a.Star,Defaulter:a.Defaulter,HighServerUsage:a.HighServerUsage,Skills:a.Skills,Resume:this.FileContent,Extra1:"EExtra1",Extra2:"EExtra2",CreatedOn:new Date,CreatedBy:"DemoUser"};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","POST",{},p,this).then(function(e){s.getView().setBusy(false);sap.m.MessageToast.show("Customer Saved successfully");s.destroyMessagePopover();s.oSuppPopup.close()}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}else{var c=" ";if(a.Star==true){c="true"}else{c="false"}var m=" ";if(a.Defaulter==true){m="true"}else{m="false"}var h=" ";if(a.HighServerUsage==true){h="true"}else{h="false"}var p={GmailId:a.GmailId,Name:a.Name,CompanyMail:a.CompanyMail,Country:a.Country,Designation:a.Designation,OtherEmail1:a.OtherEmail1,OtherEmail2:a.OtherEmail2,ContactNo:a.ContactNo,Star:c,Defaulter:m,HighServerUsage:h,Skills:a.Skills,Resume:this.FileContent,Extra1:"EExtra1",Extra2:"EExtra2",ChangedOn:new Date,ChangedBy:"DemoUser"};var y="/Students";y=y+"("+"'"+s.customerGUID+"'"+")";this.ODataHelper.callOData(this.getOwnerComponent().getModel(),y,"PUT",{},p,this).then(function(e){s.getView().setBusy(false);sap.m.MessageToast.show("Customer updated successfully");s.destroyMessagePopover();s.oSuppPopup.close()}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}},onLiveSearch:function(e){var t=e.getParameter("query");if(!t){t=e.getParameter("value")}if(this.sId.indexOf("customerId")!==-1){if(t){var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SchoolName",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Wards",template:new sap.m.ObjectListItem({title:"{Name}",intro:"{SchoolName}",number:"{RollNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("courseId")!==-1){if(t){var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("BatchNo",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Courses",template:new sap.m.DisplayListItem({label:"{Name}",value:"{BatchNo}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("accountDetails")!==-1){if(t){var s=new sap.ui.model.Filter("value",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("key",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"local>/accountSet",template:new sap.m.DisplayListItem({label:"{local>value}",value:"{local>key}"})});this.searchPopup.getBinding("items").filter([])}}else if(this.sId.indexOf("idEmailCust")!==-1){if(t){var s=new sap.ui.model.Filter("EmailId",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("FirstName",sap.ui.model.FilterOperator.Contains,t);var i=new sap.ui.model.Filter({filters:[s,a],and:false});var r=[i];this.searchPopup.getBinding("items").filter(r)}else{this.searchPopup.bindAggregation("items",{path:"/Inquries",template:new sap.m.DisplayListItem({label:"{EmailId}",value:"{FirstName}"})});this.searchPopup.getBinding("items").filter([])}}},onClearScreen:function(e){this.getView().getModel("local").setProperty("/newRegistration/StartDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/PaymentDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newRegistration/EndDate",this.formatter.getFormattedDate(8));this.getView().getModel("local").setProperty("/newRegistration/PaymentDueDate",this.formatter.getFormattedDate(1));this.getView().getModel("local").setProperty("/newRegistration/StudentId",null);this.getView().getModel("local").setProperty("/newRegistration/CourseId",null);this.getView().getModel("local").setProperty("/newRegistration/Mode","L");this.getView().getModel("local").setProperty("/newRegistration/PaymentMode","IMPS");this.getView().getModel("local").setProperty("/newRegistration/AccountName",null);this.getView().getModel("local").setProperty("/newRegistration/Amount",15e3);this.getView().getModel("local").setProperty("/newRegistration/PendingAmount",0);this.getView().getModel("local").setProperty("/newRegistration/PartialPayment",false);this.getView().getModel("local").setProperty("/newRegistration/Reference",null);this.getView().getModel("local").setProperty("/newRegistration/Extra2",null);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newRegistration/Waiver",false);this.getView().getModel("local").setProperty("/newCustomer/GmailId",null);this.getView().getModel("local").setProperty("/newCustomer/Name",null);this.getView().getModel("local").setProperty("/newCustomer/Country","IN");this.getView().getModel("local").setProperty("/newCustomer/ContactNo",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail1",null);this.getView().getModel("local").setProperty("/newCustomer/OtherEmail2",null);this.getView().getModel("local").setProperty("/newCustomer/Skills",null);this.getView().getModel("local").setProperty("/newCustomer/Star",false);this.getView().getModel("local").setProperty("/newCustomer/Defaulter",false)},handleSkillChange:function(e){},handleSkillFinish:function(e){var t=e.getParameter("selectedItems");var s=" ";for(var a=0;a<t.length;a++){s+=t[a].getText();if(a!=t.length-1){s+=","}}this.getView().getModel("local").setProperty("/newCustomer/Skills",s)},onEmail:function(e){sap.ui.getCore().byId("idName").setEnabled(true)},onEmailExist:function(e){var t=e;var s=this;var a=this.getView().getModel("local").getProperty("/newCustomer");var i={};if(a.GmailId){var r=new sap.ui.model.Filter("GmailId","EQ",a.GmailId);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[r]},i,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("createNew").setText("Update");s.UpdateCustomer=true;s.customerGUID=e.results[0].id;sap.m.MessageToast.show("Email Exists. Use F4 help or Use suggestion on Email field to fetch values")}else{sap.ui.getCore().byId("createNew").setText("Create");s.UpdateCustomer=false}}).catch(function(e){sap.m.MessageToast.show("New Customer");sap.ui.getCore().byId("createNew").setText("Create");s.UpdateCustomer=false})}else{sap.ui.getCore().byId("idName").setEnabled(false);sap.m.MessageToast.show("Enter/select email id first")}},onEnter:function(e){vEmail=e.getParameters().value;var t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;sap.ui.getCore().byId("idSkills").clearSelection();sap.ui.getCore().byId("idPhone").setValue(0);sap.ui.getCore().byId("idCountry").setSelectedKey("IN");sap.ui.getCore().byId("idOtherEmail1").setValue(null);sap.ui.getCore().byId("idOtherEmail2").setValue(null);sap.ui.getCore().byId("idStar").setSelected(false);sap.ui.getCore().byId("idName").setValue(null);sap.ui.getCore().byId("idDefaulter").setSelected(false);sap.ui.getCore().byId("idHighServerUsage").setSelected(false);if(t.test(vEmail)){var s=this;var a={};var i=new sap.ui.model.Filter("GmailId","EQ",vEmail);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Students","GET",{filters:[i]},a,this).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].GmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].ContactNo){sap.ui.getCore().byId("idPhone").setValue(e.results[0].ContactNo)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}if(e.results[0].OtherEmail1){sap.ui.getCore().byId("idOtherEmail1").setValue(e.results[0].OtherEmail1)}if(e.results[0].OtherEmail2){sap.ui.getCore().byId("idOtherEmail2").setValue(e.results[0].OtherEmail2)}if(e.results[0].Defaulter){sap.ui.getCore().byId("idDefaulter").setSelected(e.results[0].Defaulter)}if(e.results[0].HighServerUsage){sap.ui.getCore().byId("idHighServerUsage").setSelected(e.results[0].HighServerUsage)}if(e.results[0].Star){sap.ui.getCore().byId("idStar").setSelected(e.results[0].Star)}sap.ui.getCore().byId("createNew").setText("Update");s.UpdateCustomer=true;s.customerGUID=e.results[0].id}else{var t;var a;var i=s;var r={};var o=new sap.ui.model.Filter("EmailId","EQ",s.vEmail);s.ODataHelper.callOData(s.getOwnerComponent().getModel(),"/Inquries","GET",{filters:[o]},r,s).then(function(e){if(e.results.length!=0){sap.ui.getCore().byId("idEmailCust").setValue(e.results[0].EmailId);sap.ui.getCore().byId("idName").setValue(e.results[0].Name);if(e.results[0].FirstName){if(e.results[0].LastName){t=e.results[0].LastName}else{t=" "}sap.ui.getCore().byId("idName").setValue(e.results[0].FirstName+" "+t)}else{a="";if(e.results[0].LastName){t=e.results[0].LastName}else{t=""}sap.ui.getCore().byId("idName").setValue(a+" "+t)}if(e.results[0].Phone){sap.ui.getCore().byId("idPhone").setValue(e.results[0].Phone)}else{sap.ui.getCore().byId("idPhone").setValue(0)}if(e.results[0].Country){sap.ui.getCore().byId("idCountry").setSelectedKey(e.results[0].Country)}else{sap.ui.getCore().byId("idCountry").setSelectedKey("IN")}sap.ui.getCore().byId("createNew").setText("Create");i.UpdateCustomer=false}else{sap.ui.getCore().byId("createNew").setText("Create");i.UpdateCustomer=false}}).catch(function(e){var t=i.getErrorMessage(e)})}}).catch(function(e){var t=s.getErrorMessage(e)})}else{sap.m.MessageToast.show("Invalid email id");return""}},onStudentLinkPress:function(e){var t=this;this.oStudentId=e.getSource().getBindingContext().getObject().StudentId;var s="/Wards('"+this.oStudentId+"')/ToInquiry";this.ODataHelper.callOData(this.getOwnerComponent().getModel(),s,"GET",null,null,this).then(function(e){t.getView().getModel("local").setProperty("/parentDetails",e);debugger}).catch(function(e){debugger});var a=e.getSource(),i=this.getView();if(!this._oPopover){this._oPopover=l.load({name:"oft.fiori.fragments.UserMenu",controller:this}).then(function(e){i.addDependent(e);return e})}this._oPopover.then(function(e){e.openBy(a)})}})});
//# sourceMappingURL=newReg.controller.js.map